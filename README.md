# Информационные медиапанели

## Задачи, ограничения, особенности

1. С обновлением контента должен справляться любой пользователь корпоративной ИС. При этом должна быть реализована система ограничения доступа к обновлению контента с помощью членства в доменных группах.
2. Решение должно работать в режиме киоска с минимальными привилегиями.
3. Решение должно самостоятельно контролировать работоспособность процесса медиаплеера и его доступность для внешнего управления.
4. Решение должно иметь механизмы дистанционного контроля проигрываемого в момент проверки контента.
5. Решение не должно создавать нагрузку на сети передачи данных и иметь возможность работать автономно без постоянного подключения к сети.
6. Задачи по синхронному воспроизведению нет.
7. Обновление контента должно происходить незаметно для потребителя.

## Описание решения

Решение для корпоративной серды, построенной на продуктах Microsoft:

* Windows
* Active Directory
* File Services

### Со стороны пользователя

Для обновления контента пользователю необходимо предварительно подготовленные файлы разместить в сетевом каталоге.
Для оптимального качества воспроизведения и снижения нагрузки на вычислительные мощности ПК, воспроизводящего контент, размеры изображения должны соответствовать возможностям дисплея, на котором они будут вопроизводиться.

* FullHD: 1920x1080 px
* 2K (QHD): 2560x1440 px
* 4K (UHD): 3840x2160 px

### Техническая часть

В качестве проигрывателя используется MPV по следующим причинам:

* Запуск из командной строки
* Количество аргументов позволяет гибко настраивать внешний вид, исключить воспроизведение аудио
* Поддержка как видеоформатов, так и статичных изображений (jpg, png, e.t.c)
* Возможность программного управления (доступна через named pipes)
* Позволяет заменить плейлист, при этом дать завершиться воспроизведению текущего медиа-файла.

## Описание автоматизированного процесса

Контент кэшируется на каждой рабочей станции, подключенной к инфодисплею, из сетевой папки-источника контента, где контент размещает пользователь, имеющий доступ.
Для исключения конфликтов доступа к файлам при обновлении, для кеширования используется схема из двух папкок:

1. Папка с контентом, который воспроизводится в текущий момент,
2. Папка в которую скачивается новый контент.

Для управления очередью воспроизведения используются три файла плейлистов:

1. Стартовывй плейлист - воспроизводится в момент старта системы, т.е. первого запуска проигрывателя.
2. Плейлист текущего воспроизведения - плейлист, используемый для воспроизведения.
3. Новый плейлист - плейлист, который заменит плейлист текущего воспроизщведения.

По завершении копирования нового контента, формируется файл нового пелйлиста. Файл стартового плейлиста перезаписывается файлом нового плейлиста.
Файл нового плейлиста передаётся для воспроизведения в медиаплеер, он становится плейлистом текущего воспроизведения, после этого очищается папка с предыдущим контентом.

### Состав решения

* MpvWatchdogApp - приложение, используемое вместо оболочки в режиме киоска. Его задача - отслеживать зупущен ли плеер, есть ли возможность управления запущенным плеером. Если хотя бы одно условие не выполняется, перезапускает плеер. Для работы приложения достаточно локального пользователя без прав администратора.
* ContentRotator - приложение, обновляющее локальный кэш медиафайлов, форимирующее плейлист, отдающее команду плееру на замену плейлиста. Для работы приложения требуется учётная запись с доступом к сетевым ресурсам (каталогу исходных медиа-файлов). Запускается как назначенное задание по расписанию средствами операционной системы (Task Scheduler).

## Установка, настройка

 1. Скачать и установить
    * [плеер MPV](https://mpv.io/installation/), 
    * [.NET Runtime 9](https://dotnet.microsoft.com/en-us/download/dotnet/9.0);
2. Создать каталог для хранения медиафайлов и плелистов;
3. Указать в файле конфигурации `appsettings.json`:
    * `MpvExecutable` путь к mpv.exe,
    * `RemoteContentFolderPath` путь к сетевому каталогу откуда брать медиафайлы,
    * `LocalContentFolderPath` путь к каталогу для хранения кэша медиафайлов,
    * `StartupPlaylistPath` путь к стартовому списку воспроизведения,
    * `AllowedExtensions` список разрешённых для воспроизведения расширейний,
    * `MpvLogPath`, `WatchdogLogPath`, `ContentRotatorLogPath` пути к логфайлам;
Остальные параметры можно оставить по умолчанию.
4. Создать локального пользователя для запуска MpvWatchdogApp с паролем;
5. Создать доменного пользователя для запуска ContentRotator;
6. Настроить запуск назначенного задания для ContentRotator от имени `NETWORK SERVICE`;
7. Настроить запуск MpvWatchDog:
    1. Используя утилиту [Autologon ](https://learn.microsoft.com/en-us/sysinternals/downloads/autologon), настроить автоматический вход в систему пользователя, от имени которого будет запущено приложение `MpvWatchdogApp`;
    2. Настроить `MpvWatchdogApp` в качестве shell для пользователя, от имени которого будет запущено приложение `MpvWatchdogApp` с помощью реестра:
```
Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon]
"Shell"="C:\\VideoInfoDisplayKiosk\\APP\\MpvWatchdogApp.exe"
```
 8. На сетевой каталог медиаконтента `RemoteContentFolderPath` дать право чтения учётной записи компьютера, на котором выполняется `ContentRotator`. В качестве лучшей практики, доступ необходимо предоставить доменной группе, в группу включить учётную запись компьютера.
